{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Dashboard</title>
  <link rel="stylesheet" href="{% static 'main/css/dashboard.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
  <section class="dashboard">
    <!-- Sidebar -->
    <aside class="sidebar">
     <div class="profile-card">
  <div class="avatar-wrapper">
    {% if student.profile_picture %}
      <img src="{{ student.profile_picture.url }}" alt="Profile" class="avatar">
    {% else %}
      <img src="{% static 'main/images/default_pfp.png' %}" alt="Profile" class="avatar">
    {% endif %}
  </div>

  <div class="profile-info">
    <h4>
      {{ student.firstname }}
      {% if student.middlename %} {{ student.middlename }} {% endif %}
      {{ student.lastname }}
    </h4>
    <p>ID: {{ student.student_id }}</p>
    <p>Section: {{ student.class_section.class_name }}</p>
  </div>

        <!-- Icons -->
        <div class="icons">
        </div>
      </div>

      <nav class="menu">

<!-- Settings -->
<form action="{% url 'student_settings' %}" method="get" class="menu-item logout-btn">
  <button type="submit" class="logout-btn">
    <i data-lucide="user-cog"></i>
    <span>Settings</span>
  </button>
</form>

<!-- Logout -->
<form id="logout-form" action="{% url 'logout' %}" method="post" class="menu-item logout-btn">
  {% csrf_token %}
  <button type="button" class="logout-btn" id="logout-button">
    <i data-lucide="log-out"></i>
    <span>Logout</span>
  </button>
</form>

      </nav>
    </aside>

    <!-- Main content -->
    <main class="content">
      <h2 class="title">STUDENT DASHBOARD</h2>
      <div class="dashboard-grid">

<!-- RESPONSE HISTORY -->
<div class="card history">
  <h3>RESPONSE HISTORY</h3>

  <!-- Search + filters form -->
  <form method="get" class="search-filter">
    <div class="filter-row">

      <!-- Search -->
      <input type="text"
             name="q"
             placeholder="Search by title"
             class="search-bar"
             value="{{ request.GET.q }}">

      <!-- Sort -->
      <select name="order" id="sort_history">
        <option value="newest"
          {% if request.GET.order == "newest" or not request.GET.order %}
            selected
          {% endif %}>
          Newest
        </option>

        <option value="oldest"
          {% if request.GET.order == "oldest" %}
            selected
          {% endif %}>
          Oldest
        </option>
      </select>

      <!-- Auto-submit script -->
      <script>
        document.addEventListener("DOMContentLoaded", () => {
          const sortHistory = document.getElementById("sort_history");
          if (sortHistory) {
            sortHistory.addEventListener("change", () => {
              sortHistory.form.submit();
            });
          }
        });
      </script>

      <!-- Filter button -->
      <button type="submit" class="btn-filter">
        <i data-lucide="funnel"></i>
        <span>Filter</span>
      </button>

      <!-- Clear -->
      <a href="{% url 'admin_responses' %}" class="btn-clear">
        <i data-lucide="x-circle"></i>
        <span>Clear</span>
      </a>

    </div>
  </form>

  <div class="response-table">
    <div class="table-row header">
      <div class="col">Survey</div>
      <div class="col">Date</div>
      <div class="col">Status</div>
    </div>

    <div class="table-body">
      {% if responses %}
        {% for history in responses %}
          <div class="table-row">
            <div class="col">
              <a href="{% url 'response_history' history.history_id %}"
                 class="response-link">
                {{ history.survey.title }}
              </a>
            </div>
            <div class="col">
              {{ history.submitted_at|date:"F d, Y" }}
            </div>
            <div class="col status completed">Completed</div>
          </div>
        {% endfor %}
      {% else %}
        <div class="table-row">
          <div class="col">No responses found.</div>
          <div class="col"></div>
          <div class="col"></div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

        <!-- ASSIGNED SURVEYS -->
        <div class="card assigned-surveys">
          <h3>ASSIGNED SURVEY</h3>
<form method="get" class="search-filter">
  <div class="filter-row">

    <input type="text"
           name="search_survey"
           placeholder="Search by title"
           class="search-bar"
           value="{{ request.GET.search_survey }}">

<select name="sort_survey" id="sort_survey_assigned">


  <option value="newest"
    {% if request.GET.sort_survey == "newest" or not request.GET.sort_survey %}
      selected
    {% endif %}>
    Newest
  </option>

  <option value="oldest"
    {% if request.GET.sort_survey == "oldest" %}
      selected
    {% endif %}>
    Oldest
  </option>

</select>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const sortAssigned = document.getElementById("sort_survey_assigned");
  if (sortAssigned) {
    sortAssigned.addEventListener("change", () => {
      sortAssigned.form.submit();
    });
  }
});
</script>



    <button type="submit" class="btn-filter">
      <i data-lucide="funnel"></i>
      <span>Filter</span>
    </button>

    <a href="{% url 'dashboard' %}" class="btn-clear">
      <i data-lucide="x-circle"></i>
      <span>Clear</span>
    </a>

  </div>
</form>

          {% if surveys %}
            <div class="survey-card-list">
              {% for survey in surveys %}
                <div class="survey-card">
                  <div class="survey-card-main">
                    <h4 class="survey-card-title">{{ survey.title }}</h4>

                    <p class="survey-card-row">
                      <span class="label">Status:</span>
                      {% if survey.status == "closed" %}
                        <span class="status-badge status-closed">Closed</span>
                      {% else %}
                        <span class="status-badge status-open">Open</span>
                      {% endif %}
                    </p>

                    <p class="survey-card-row">
                      <span class="label">Deadline:</span>
                      {% if survey.due_date %}
                        <span class="deadline-date">
                          {{ survey.due_date|date:"F d, Y" }}
                        </span>
                      {% else %}
                        <span class="deadline-date no-deadline">No deadline</span>
                      {% endif %}
                    </p>
                  </div>

                  <div class="survey-card-actions">
                    {% if survey.status == "closed" %}
                      <button class="btn-take-survey disabled" disabled>
                        Closed
                      </button>
                    {% else %}
                      <a href="{% url 'take_survey' survey.survey_id %}"
                         class="btn-take-survey">
                        Take Survey
                      </a>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="no-surveys">No surveys assigned to your section right now.</p>
          {% endif %}
        </div>

      </div>
    </main>
  </section>

  <footer>
    <p>Â© 2025 SURVEYLYZE | All rights reserved.</p>
  </footer>

  <script>
    lucide.createIcons();
  </script>

    <!-- Logout Confirmation Modal -->
  <div id="logout-modal" class="logout-modal-overlay">
    <div class="logout-modal">
      <div class="logout-modal-header">
        <i data-lucide="log-out" class="logout-icon"></i>
        <h3>Confirm Logout</h3>
      </div>
      <div class="logout-modal-body">
        <p>Are you sure you want to logout?</p>
      </div>
      <div class="logout-modal-footer">
        <button class="logout-modal-btn cancel" id="logout-cancel">Cancel</button>
        <button class="logout-modal-btn confirm" id="logout-confirm">Logout</button>
      </div>
    </div>
  </div>

  <script>
    // Initialize Lucide icons first
    lucide.createIcons();

    // Logout confirmation logic (wrapped in DOMContentLoaded to prevent bugs)
    document.addEventListener('DOMContentLoaded', function() {
      const logoutButton = document.getElementById('logout-button');
      const logoutForm = document.getElementById('logout-form');
      const logoutModal = document.getElementById('logout-modal');
      const logoutCancel = document.getElementById('logout-cancel');
      const logoutConfirm = document.getElementById('logout-confirm');

      if (logoutButton && logoutModal && logoutForm) {
        // Show modal when logout button is clicked
        logoutButton.addEventListener('click', function(e) {
          e.preventDefault();
          logoutModal.classList.add('show');
        });

        // Hide modal when cancel is clicked
        logoutCancel.addEventListener('click', function() {
          logoutModal.classList.remove('show');
        });

        // Submit form when confirm is clicked
        logoutConfirm.addEventListener('click', function() {
          logoutForm.submit();
        });

        // Close modal when clicking outside
        logoutModal.addEventListener('click', function(e) {
          if (e.target === logoutModal) {
            logoutModal.classList.remove('show');
          }
        });
      }
    });
  </script>
</body>
</html>

</body>
</html>
