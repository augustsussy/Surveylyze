{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ survey.title }} | SURVEYLYZE</title>
  <link rel="stylesheet" href="{% static 'main/css/survey.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Top Navbar -->
  <header class="top-nav">
    <div class="brand">
      <h1>SURVEYLYZE</h1>
    </div>
    <div class="profile-menu">
      <img src="{% static 'main/images/Alhaitham.png' %}" alt="Profile" class="profile-icon" id="profile-btn">

      <div class="dropdown-panel" id="profile-panel">
        <div class="profile-header">
          <h3>{{ request.user.first_name|default:"Student" }}</h3>
        </div>
        <a href="{% url 'dashboard' %}">
          <i class="icon">üè†</i> Dashboard
        </a>
        <a href="{% url 'landing' %}">
          <i class="icon">üö™</i> Logout
        </a>
      </div>
    </div>
  </header>

  <!-- Survey Section -->
  <main class="survey-wrapper">
    <section class="survey-container">
      <div class="survey-card">
        <!-- dynamic title/description -->
        <h2>{{ survey.title }}</h2>
        {% if survey.description %}
          <p class="survey-description">{{ survey.description }}</p>
        {% endif %}

        <!-- Tabs -->
        <div class="survey-tabs">
          <button class="tab active" data-step="0">Questions</button>
        </div>

        <div class="progress-bar">
          <div class="progress"></div>
          <span class="progress-text">1/1</span>
        </div>

        <!-- Survey form -->
        <form id="survey-form" method="post">
          {% csrf_token %}

          <!-- One step containing all questions for now -->
          <div class="survey-step active">
            {% for question in questions %}
              <div class="question-block">

                {# LIKERT -> star rating card #}
                {% if question.question_type == "likert" or question.question_type == "likert_scale" %}
                  <div class="rating-question">
                    <div class="rating-header">
                      <span class="rating-label">
                        {{ question.order_number }}. {{ question.question }}
                      </span>
                      <span class="rating-score" id="score_q{{ question.question_id }}">0 / 5</span>
                    </div>

                    <div class="rating-card">
                      <div class="star-rating" data-question-id="q{{ question.question_id }}">
                        {% for i in "12345" %}
                          <input
                            type="radio"
                            id="q{{ question.question_id }}_{{ forloop.counter }}"
                            name="q{{ question.question_id }}"
                            value="{{ forloop.counter }}"
                          >
                          <label for="q{{ question.question_id }}_{{ forloop.counter }}">‚òÖ</label>
                        {% endfor %}
                      </div>
                    </div>
                  </div>

                {# SHORT ANSWER / MCQ use the normal layout #}
                {% else %}
                  <label>{{ question.order_number }}. {{ question.question }}</label>

                  {# SHORT ANSWER -> text box #}
                  {% if question.question_type == "short_answer" %}
                    <input
                      type="text"
                      name="q{{ question.question_id }}"
                      placeholder="Type your answer"
                    >

                  {# MCQ -> dropdown from options #}
                  {% elif question.question_type == "mcq" %}
                    <select name="q{{ question.question_id }}">
                      <option value="">Select an option</option>
                      {% for opt in question.options.all %}
                        <option value="{{ opt.option_id }}">{{ opt.option_text }}</option>
                      {% empty %}
                        <option disabled>No options defined</option>
                      {% endfor %}
                    </select>
                  {% endif %}
                {% endif %}
              </div>
            {% empty %}
              <p>No questions defined for this survey.</p>
            {% endfor %}
          </div>

          <!-- Navigation buttons -->
          <div class="form-navigation">
            <button type="button" class="btn prev" disabled>Previous</button>
            <button type="submit" class="btn next">Submit</button>
          </div>
        </form>
      </div>
    </section>
  </main>

  <footer class="footer">
    <p>¬© 2025 SURVEYLYZE | All rights reserved.</p>
  </footer>

  <script src="{% static 'main/Javascript/survey.js' %}"></script>

  <!-- Optional: live update for "x / 5" score text -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const starGroups = document.querySelectorAll('.star-rating');

      starGroups.forEach(group => {
        const radios = group.querySelectorAll('input[type="radio"]');
        const qName = group.getAttribute('data-question-id');
        const scoreEl = document.getElementById('score_' + qName.replace('q', ''));

        radios.forEach(radio => {
          radio.addEventListener('change', () => {
            if (scoreEl) {
              scoreEl.textContent = radio.value + ' / 5';
            }
          });
        });
      });
    });
  </script>
</body>
</html>
