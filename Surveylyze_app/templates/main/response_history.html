{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Survey Response - {{ history.survey.title }}</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{% static 'main/css/response_history.css' %}">

  <!-- Debugging: Check if CSS loads -->
  <style>
    /* Fallback styling if external CSS doesn't load */
    body.test-fallback {
      background: linear-gradient(135deg, #e1caff 0%, #e3d0f5 100%);
    }
  </style>
</head>
<body class="test-fallback">
  <div class="container">
    <div class="response-card">
      <!-- Header -->
      <div class="card-header">
        {% if user.is_staff or user.is_superuser %}
          <a href="{% url 'admin_responses' %}" class="back-btn">
            <i class="bi bi-arrow-left"></i> Back to Responses
          </a>
        {% else %}
          <a href="{% url 'dashboard' %}" class="back-btn">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
          </a>
        {% endif %}
        <h1 class="survey-title">{{ history.survey.title }}</h1>
      </div>

      <!-- Body -->
      <div class="card-body">
        <!-- Submission Date -->
        <div class="submission-info">
          <div class="date">
            <i class="bi bi-calendar-check"></i>
            <strong>Submitted:</strong> {{ history.submitted_at|date:"F d, Y - h:i A" }}
          </div>
        </div>

        <!-- Info Table -->
        <div class="info-table">
          <div class="info-row">
            <div class="info-label">
              <i class="bi bi-person"></i> Submitted By
            </div>
            <div class="info-value">
              {{ history.student.firstname }} {{ history.student.lastname }}
            </div>
          </div>

          <div class="info-row">
            <div class="info-label">
              <i class="bi bi-calendar3"></i> Submitted On
            </div>
            <div class="info-value">
              {{ history.submitted_at|date:"F d, Y - h:i A" }}
            </div>
          </div>

          <div class="info-row">
            <div class="info-label">
              <i class="bi bi-clock"></i> Duration
            </div>
            <div class="info-value">
              {% if history.duration %}
                {{ history.duration }} seconds
              {% else %}
                Not recorded
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Responses -->
        <div class="responses-section">
          <h2 class="section-title">
            <i class="bi bi-chat-left-text"></i> Responses
          </h2>

          {% if answers %}
            {% for ans in answers %}
              <div class="question-block">
                <div class="question-label">
                  Q{{ ans.question.order_number }}. {{ ans.question.question }}
                </div>

                {# SHORT ANSWER #}
                {% if ans.question.question_type == "short_answer" %}
                  <div class="answer-content">
                    {{ ans.shortanswer_text|default:"No answer provided" }}
                  </div>

                {# LIKERT #}
                {% elif ans.question.question_type == "likert" or ans.question.question_type == "likert_scale" %}
                  <div class="likert-stars">
                    {% for i in "12345" %}
                      <i class="bi bi-star-fill likert-star {% if forloop.counter <= ans.likert_value %}filled{% endif %}"></i>
                    {% endfor %}
                    {% if ans.likert_value %}
                      <span class="likert-value">{{ ans.likert_value }} / 5</span>
                    {% endif %}
                  </div>

                {# MCQ #}
                {% elif ans.question.question_type == "mcq" %}
                  <div class="mcq-answer">
                    <div class="mcq-dot"></div>
                    <div>
                      {% if ans.choice_id %}
                        {% for opt in ans.question.options.all %}
                          {% if opt.option_id == ans.choice_id %}
                            {{ opt.option_text }}
                          {% endif %}
                        {% endfor %}
                      {% else %}
                        No option selected
                      {% endif %}
                    </div>
                  </div>

                {# Fallback #}
                {% else %}
                  <div class="answer-content">
                    {{ ans.shortanswer_text|default:ans.choice_id|default:ans.likert_value|default:"No answer" }}
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          {% else %}
            <div class="empty-state">
              <i class="bi bi-inbox"></i>
              <p>No responses found for this submission.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>